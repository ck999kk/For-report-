{% extends "base.html" %}

{% block title %}Reports - Professional Phone Intelligence System{% endblock %}

{% block extra_css %}
<style>
    .reports-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }
    
    .report-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
    }
    
    .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    }
    
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px 15px 0 0;
    }
    
    .report-status {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .status-completed {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .status-processing {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .status-failed {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
    
    .filter-tabs {
        background: white;
        border-radius: 15px;
        padding: 0.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .filter-tab {
        border: none;
        background: transparent;
        padding: 0.75rem 1.5rem;
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .filter-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .search-bar {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .btn-download {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: transform 0.2s ease;
    }
    
    .btn-download:hover {
        transform: translateY(-2px);
        color: white;
    }
    
    .btn-view {
        background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%);
        border: none;
        color: white;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: 500;
        transition: transform 0.2s ease;
    }
    
    .btn-view:hover {
        transform: translateY(-2px);
        color: white;
    }
    
    .confidence-indicator {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #e9ecef;
        overflow: hidden;
    }
    
    .confidence-bar {
        height: 100%;
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    
    .confidence-high {
        background: linear-gradient(90deg, #28a745, #20c997);
    }
    
    .confidence-medium {
        background: linear-gradient(90deg, #ffc107, #fd7e14);
    }
    
    .confidence-low {
        background: linear-gradient(90deg, #dc3545, #e83e8c);
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .stats-row {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 1rem;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-6 mb-2">
                <i class="fas fa-file-alt me-3"></i>Investigation Reports
            </h1>
            <p class="text-muted">
                View, download, and manage your investigation reports
            </p>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="row">
        <div class="col-12">
            <div class="stats-row">
                <div class="row" id="reportStats">
                    <div class="col-md-3 stat-item">
                        <div class="stat-number" id="totalReports">0</div>
                        <div class="stat-label">Total Reports</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number" id="completedReports">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number" id="processingReports">0</div>
                        <div class="stat-label">Processing</div>
                    </div>
                    <div class="col-md-3 stat-item">
                        <div class="stat-number" id="todayReports">0</div>
                        <div class="stat-label">Today</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row">
        <div class="col-12">
            <div class="search-bar">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="searchReports" 
                                   placeholder="Search reports by phone number, investigation ID, or date...">
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" id="exportAllBtn">
                                <i class="fas fa-download me-2"></i>Export All
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="refreshBtn">
                                <i class="fas fa-sync me-2"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="filter-tabs">
                <div class="d-flex">
                    <button class="filter-tab active" data-filter="all">
                        <i class="fas fa-list me-2"></i>All Reports
                    </button>
                    <button class="filter-tab" data-filter="completed">
                        <i class="fas fa-check-circle me-2"></i>Completed
                    </button>
                    <button class="filter-tab" data-filter="processing">
                        <i class="fas fa-spinner me-2"></i>Processing
                    </button>
                    <button class="filter-tab" data-filter="failed">
                        <i class="fas fa-times-circle me-2"></i>Failed
                    </button>
                    <button class="filter-tab" data-filter="recent">
                        <i class="fas fa-clock me-2"></i>Recent
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Grid -->
    <div class="row">
        <div class="col-12">
            <div id="reportsContainer">
                <div class="d-flex justify-content-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading reports...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Details Modal -->
<div class="modal fade" id="reportDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-alt me-2"></i>Report Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reportDetailsContent">
                <!-- Report details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadFromModal">
                    <i class="fas fa-download me-2"></i>Download Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions Modal -->
<div class="modal fade" id="bulkActionsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Bulk Actions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Select an action to perform on all visible reports:</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="bulkDownload()">
                        <i class="fas fa-download me-2"></i>Download All as ZIP
                    </button>
                    <button class="btn btn-info" onclick="bulkExport()">
                        <i class="fas fa-file-excel me-2"></i>Export Summary to CSV
                    </button>
                    <button class="btn btn-warning" onclick="bulkArchive()">
                        <i class="fas fa-archive me-2"></i>Archive Selected
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allReports = [];
    let filteredReports = [];
    let currentFilter = 'all';
    let selectedReportId = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize
        loadReports();
        initializeEventHandlers();
        
        // Auto-refresh every 2 minutes
        setInterval(loadReports, 120000);
    });
    
    function initializeEventHandlers() {
        // Filter tabs
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                setActiveFilter(this.dataset.filter);
            });
        });
        
        // Search
        document.getElementById('searchReports').addEventListener('input', function() {
            filterReports(this.value);
        });
        
        // Refresh button
        document.getElementById('refreshBtn').addEventListener('click', loadReports);
        
        // Export all button
        document.getElementById('exportAllBtn').addEventListener('click', function() {
            const modal = new bootstrap.Modal(document.getElementById('bulkActionsModal'));
            modal.show();
        });
    }
    
    function loadReports() {
        fetch('/api/investigations')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    allReports = data.investigations;
                    updateStatistics();
                    applyCurrentFilter();
                } else {
                    showError('Failed to load reports');
                }
            })
            .catch(error => {
                console.error('Error loading reports:', error);
                showError('Error loading reports: ' + error.message);
            });
    }
    
    function updateStatistics() {
        const total = allReports.length;
        const completed = allReports.filter(r => r.status === 'completed').length;
        const processing = allReports.filter(r => r.status === 'active').length;
        const today = allReports.filter(r => {
            const reportDate = new Date(r.started_at).toDateString();
            return reportDate === new Date().toDateString();
        }).length;
        
        document.getElementById('totalReports').textContent = total;
        document.getElementById('completedReports').textContent = completed;
        document.getElementById('processingReports').textContent = processing;
        document.getElementById('todayReports').textContent = today;
    }
    
    function setActiveFilter(filter) {
        currentFilter = filter;
        
        // Update active tab
        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
        
        applyCurrentFilter();
    }
    
    function applyCurrentFilter() {
        let filtered = [...allReports];
        
        switch (currentFilter) {
            case 'completed':
                filtered = filtered.filter(r => r.status === 'completed');
                break;
            case 'processing':
                filtered = filtered.filter(r => r.status === 'active');
                break;
            case 'failed':
                filtered = filtered.filter(r => r.status === 'failed');
                break;
            case 'recent':
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                filtered = filtered.filter(r => new Date(r.started_at) > oneDayAgo);
                break;
        }
        
        filteredReports = filtered;
        renderReports();
    }
    
    function filterReports(searchTerm) {
        if (!searchTerm.trim()) {
            applyCurrentFilter();
            return;
        }
        
        const term = searchTerm.toLowerCase();
        filteredReports = allReports.filter(report => {
            return report.phone_number.toLowerCase().includes(term) ||
                   report.investigation_id.toLowerCase().includes(term) ||
                   new Date(report.started_at).toLocaleDateString().includes(term);
        });
        
        renderReports();
    }
    
    function renderReports() {
        const container = document.getElementById('reportsContainer');
        
        if (filteredReports.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h4>No Reports Found</h4>
                    <p class="text-muted">
                        ${currentFilter === 'all' ? 'No investigation reports available yet.' : 
                          `No reports match the current filter: ${currentFilter}`}
                    </p>
                    <button class="btn btn-primary" onclick="window.location.href='/investigate'">
                        <i class="fas fa-plus me-2"></i>Start New Investigation
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="reports-grid">
                ${filteredReports.map(report => createReportCard(report)).join('')}
            </div>
        `;
    }
    
    function createReportCard(report) {
        const statusClass = getStatusClass(report.status);
        const confidenceLevel = getConfidenceLevel(report);
        const confidenceClass = getConfidenceClass(confidenceLevel);
        
        return `
            <div class="card report-card">
                <div class="report-header">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0">
                            <i class="fas fa-phone me-2"></i>${report.phone_number}
                        </h6>
                        <span class="report-status ${statusClass}">
                            ${report.status.charAt(0).toUpperCase() + report.status.slice(1)}
                        </span>
                    </div>
                    <small class="opacity-75">
                        ID: ${report.investigation_id.substring(0, 12)}...
                    </small>
                </div>
                
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted">Started</small>
                            <div class="fw-bold">${formatDate(report.started_at)}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Progress</small>
                            <div class="fw-bold">${report.progress?.toFixed(1) || 0}%</div>
                        </div>
                    </div>
                    
                    ${report.status === 'completed' ? `
                    <div class="mb-3">
                        <small class="text-muted">Confidence Level</small>
                        <div class="d-flex align-items-center mt-1">
                            <div class="confidence-indicator me-2">
                                <div class="confidence-bar ${confidenceClass}" style="width: ${confidenceLevel}%"></div>
                            </div>
                            <small class="fw-bold">${confidenceLevel > 75 ? 'High' : confidenceLevel > 50 ? 'Medium' : 'Low'}</small>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="d-flex gap-2">
                        ${report.status === 'completed' ? `
                        <button class="btn btn-download btn-sm flex-fill" onclick="downloadReport('${report.investigation_id}')">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                        ` : ''}
                        <button class="btn btn-view btn-sm flex-fill" onclick="viewReportDetails('${report.investigation_id}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                    </div>
                </div>
                
                ${report.status === 'active' ? `
                <div class="card-footer bg-transparent">
                    <div class="progress" style="height: 4px;">
                        <div class="progress-bar bg-primary" style="width: ${report.progress || 0}%"></div>
                    </div>
                </div>
                ` : ''}
            </div>
        `;
    }
    
    function getStatusClass(status) {
        switch (status) {
            case 'completed': return 'status-completed';
            case 'active': return 'status-processing';
            case 'failed': return 'status-failed';
            default: return 'status-processing';
        }
    }
    
    function getConfidenceLevel(report) {
        // Mock confidence calculation
        return Math.floor(Math.random() * 40) + 60; // 60-100%
    }
    
    function getConfidenceClass(level) {
        if (level > 75) return 'confidence-high';
        if (level > 50) return 'confidence-medium';
        return 'confidence-low';
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function downloadReport(investigationId) {
        window.location.href = `/api/download_report/${investigationId}`;
    }
    
    function viewReportDetails(investigationId) {
        selectedReportId = investigationId;
        
        // Load report details
        fetch(`/api/investigation_status/${investigationId}`)
            .then(response => response.json())
            .then(data => {
                showReportDetails(data);
            })
            .catch(error => {
                showError('Error loading report details: ' + error.message);
            });
    }
    
    function showReportDetails(report) {
        const content = document.getElementById('reportDetailsContent');
        
        content.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Investigation Information</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Phone Number:</strong></td><td>${report.phone_number}</td></tr>
                        <tr><td><strong>Investigation ID:</strong></td><td>${report.investigation_id}</td></tr>
                        <tr><td><strong>Investigator:</strong></td><td>${report.investigator}</td></tr>
                        <tr><td><strong>Status:</strong></td><td><span class="badge bg-${report.status === 'completed' ? 'success' : 'warning'}">${report.status}</span></td></tr>
                        <tr><td><strong>Started:</strong></td><td>${formatDate(report.started_at)}</td></tr>
                        ${report.completed_at ? `<tr><td><strong>Completed:</strong></td><td>${formatDate(report.completed_at)}</td></tr>` : ''}
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Progress Information</h6>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Overall Progress</span>
                            <span>${report.progress?.toFixed(1) || 0}%</span>
                        </div>
                        <div class="progress mt-1">
                            <div class="progress-bar" style="width: ${report.progress || 0}%"></div>
                        </div>
                    </div>
                    ${report.has_results ? '<div class="alert alert-success"><i class="fas fa-check me-2"></i>Results available</div>' : ''}
                    ${report.report_available ? '<div class="alert alert-info"><i class="fas fa-file-alt me-2"></i>Report generated</div>' : ''}
                </div>
            </div>
        `;
        
        // Setup download button
        document.getElementById('downloadFromModal').onclick = () => downloadReport(selectedReportId);
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
        modal.show();
    }
    
    function showError(message) {
        const container = document.getElementById('reportsContainer');
        container.innerHTML = `
            <div class="alert alert-danger text-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            </div>
        `;
    }
    
    // Bulk actions
    function bulkDownload() {
        alert('Bulk download feature would be implemented here');
        bootstrap.Modal.getInstance(document.getElementById('bulkActionsModal')).hide();
    }
    
    function bulkExport() {
        alert('CSV export feature would be implemented here');
        bootstrap.Modal.getInstance(document.getElementById('bulkActionsModal')).hide();
    }
    
    function bulkArchive() {
        alert('Archive feature would be implemented here');
        bootstrap.Modal.getInstance(document.getElementById('bulkActionsModal')).hide();
    }
</script>
{% endblock %}